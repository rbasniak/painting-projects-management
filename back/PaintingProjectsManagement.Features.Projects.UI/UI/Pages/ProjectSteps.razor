@page "/projects/{ProjectId:guid}/execution/steps"
@using MudBlazor
@using PaintingProjectsManagement.UI.Modules.Projects
@using PaintingProjectsManagement.UI.Modules.Projects.UI.Dialogs
@using PaintingProjectsManagement.UI.Modules.Shared
@using Microsoft.AspNetCore.Components

<MudPaper Class="pa-4">
    <MudStack Spacing="3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5">Project Steps</MudText>
            <MudButton 
                Variant="Variant.Filled" 
                Color="Color.Primary" 
                Size="Size.Large"
                StartIcon="@Icons.Material.Filled.Add"
                OnClick="AddStep">
                Add Step
            </MudButton>
        </MudStack>

        @if (isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (stepsGrouped.StepsByType.Any())
        {
            @foreach (var stepGroup in stepsGrouped.StepsByType.OrderBy(x => x.Key.Id))
            {
                <MudExpansionPanels>
                    <MudExpansionPanel Text="@stepGroup.Key.Value" IsExpanded="true">
                        <MudTable Items="stepGroup.Value" Hover="true" Dense="false" Breakpoint="Breakpoint.None">
                            <HeaderContent>
                                <MudTh>Date</MudTh>
                                <MudTh>Duration</MudTh>
                                <MudTh Style="width: 120px">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Date">@FormatDate(context.Date)</MudTd>
                                <MudTd DataLabel="Duration">@FormatDuration(context.DurationInHours)</MudTd>
                                <MudTd>
                                    <MudIconButton 
                                        Icon="@Icons.Material.Filled.Edit" 
                                        OnClick="() => EditStep(context)" 
                                        Color="Color.Primary"
                                        Size="Size.Large" />
                                    <MudIconButton 
                                        Icon="@Icons.Material.Filled.Delete" 
                                        OnClick="() => DeleteStep(context)" 
                                        Color="Color.Error"
                                        Size="Size.Large" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
        }
        else
        {
            <MudText>No steps added to this project yet.</MudText>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter] public Guid ProjectId { get; set; }
    [Inject] public IProjectsService ProjectsService { get; set; } = default!;
    [Inject] public IDialogService DialogService { get; set; } = default!;
    [Inject] public ISnackbar Snackbar { get; set; } = default!;

    private ProjectStepsGrouped stepsGrouped = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadStepsAsync();
    }

    private async Task LoadStepsAsync()
    {
        try
        {
            isLoading = true;
            stepsGrouped = await ProjectsService.GetProjectStepsAsync(ProjectId, default);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading steps: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private string FormatDate(DateTime date)
    {
        return date.ToString("yyyy-MM-dd HH:mm");
    }

    private string FormatDuration(double duration)
    {
        var hours = (int)duration;
        var minutes = (int)((duration - hours) * 60);
        
        if (minutes > 0)
            return $"{hours}h {minutes}m";
        return $"{hours}h";
    }

    private async Task AddStep()
    {
        var parameters = new DialogParameters { ["ProjectId"] = ProjectId };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<AddStepDialog>("Add Step", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadStepsAsync();
        }
    }

    private async Task EditStep(ProjectStepDetails step)
    {
        var parameters = new DialogParameters 
        { 
            ["ProjectId"] = ProjectId,
            ["StepId"] = step.Id,
            ["CurrentDate"] = step.Date,
            ["CurrentDuration"] = step.DurationInHours
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<AdjustStepDurationDialog>("Edit Step", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadStepsAsync();
        }
    }

    private async Task DeleteStep(ProjectStepDetails step)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Delete Step",
            $"Delete this step?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await ProjectsService.DeleteProjectStepAsync(ProjectId, step.Id, default);
                Snackbar.Add("Step deleted successfully", Severity.Success);
                await LoadStepsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting step: {ex.Message}", Severity.Error);
            }
        }
    }
}
