@using MudBlazor
@using PaintingProjectsManagement.UI.Modules.Projects

@namespace PaintingProjectsManagement.UI.Modules.Projects.UI.Dialogs

<MudDialog>
    <DialogContent>
        <MudStack Spacing="4">
            <MudSelect 
                @bind-Value="selectedStepType"
                Label="Step Type"
                Variant="Variant.Outlined"
                Required="true">
                <MudSelectItem Value="10">Planning</MudSelectItem>
                <MudSelectItem Value="20">Supporting</MudSelectItem>
                <MudSelectItem Value="30">Printing</MudSelectItem>
                <MudSelectItem Value="40">Cleaning</MudSelectItem>
                <MudSelectItem Value="50">Post Processing</MudSelectItem>
                <MudSelectItem Value="60">Painting</MudSelectItem>
            </MudSelect>

            <MudDatePicker 
                @bind-Date="stepDate" 
                Label="Date" 
                Variant="Variant.Outlined"
                Required="true" />

            <MudTimePicker 
                @bind-Time="stepTime" 
                Label="Time" 
                Variant="Variant.Outlined" />

            <MudTextField 
                @bind-Value="duration" 
                Label="Duration (hours)" 
                Variant="Variant.Outlined"
                InputType="InputType.Number"
                Adornment="Adornment.End"
                AdornmentText="hours"
                Style="font-size: 1.5rem;" />

            <MudText Typo="Typo.body2" Class="mb-2">Quick Adjustments:</MudText>
            
            <MudGrid>
                <MudItem xs="3">
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Color="Color.Error" 
                        Size="Size.Large"
                        FullWidth="true"
                        OnClick="() => AdjustDuration(-1)">
                        -1h
                    </MudButton>
                </MudItem>
                <MudItem xs="3">
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Color="Color.Error" 
                        Size="Size.Large"
                        FullWidth="true"
                        OnClick="() => AdjustDuration(-0.5)">
                        -30m
                    </MudButton>
                </MudItem>
                <MudItem xs="3">
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Color="Color.Error" 
                        Size="Size.Large"
                        FullWidth="true"
                        OnClick="() => AdjustDuration(-0.25)">
                        -15m
                    </MudButton>
                </MudItem>
                <MudItem xs="3">
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Color="Color.Success" 
                        Size="Size.Large"
                        FullWidth="true"
                        OnClick="() => AdjustDuration(0.25)">
                        +15m
                    </MudButton>
                </MudItem>
                <MudItem xs="3">
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Color="Color.Success" 
                        Size="Size.Large"
                        FullWidth="true"
                        OnClick="() => AdjustDuration(0.5)">
                        +30m
                    </MudButton>
                </MudItem>
                <MudItem xs="3">
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Color="Color.Success" 
                        Size="Size.Large"
                        FullWidth="true"
                        OnClick="() => AdjustDuration(1)">
                        +1h
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Size="Size.Large">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save" Size="Size.Large">Add Step</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Guid ProjectId { get; set; }

    [Inject] public IProjectsService ProjectsService { get; set; } = default!;
    [Inject] public ISnackbar Snackbar { get; set; } = default!;

    private int? selectedStepType = null;
    private DateTime? stepDate = DateTime.Now.Date;
    private TimeSpan? stepTime = DateTime.Now.TimeOfDay;
    private double duration = 0;

    private void AdjustDuration(double delta)
    {
        duration = Math.Max(0, duration + delta);
    }

    private async Task Save()
    {
        if (!selectedStepType.HasValue || !stepDate.HasValue || duration <= 0)
        {
            Snackbar.Add("Please fill in all required fields", Severity.Warning);
            return;
        }

        try
        {
            var date = stepDate.Value.Date;
            if (stepTime.HasValue)
            {
                date = date.Add(stepTime.Value);
            }

            await ProjectsService.AddProjectStepAsync(ProjectId, selectedStepType.Value, date, duration, default);
            MudDialog.Close(DialogResult.Ok(true));
            Snackbar.Add("Step added successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding step: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
