@using MudBlazor
@using PaintingProjectsManagement.Features.Projects.UI
@using System.Text.Json

@namespace PaintingProjectsManagement.UI.Modules.Projects.UI.Dialogs
@implements IAsyncDisposable

<MudDialog Class="color-zones-dialog">
    <DialogContent>
        <MudPaper Class="pa-4" Style="height: calc(100vh - 120px); display: flex; flex-direction: column;">
            <MudStack Spacing="2">
                <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="Justify.SpaceBetween">
                    <div>
                        <MudText Typo="Typo.h4">@Model?.Name</MudText>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Color Zones Management</MudText>
                    </div>
                </MudStack>

                @if (Model?.References == null || !Model.References.Any())
                {
                    <MudAlert Severity="Severity.Warning">No reference images available for this project.</MudAlert>
                }
                else
                {
                    <!-- Image Carousel -->
                    <MudPaper Elevation="1" Class="pa-2">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">Select Reference Image</MudText>
                        <div style="display: flex; gap: 8px; overflow-x: auto; padding: 8px 0;">
                            @for (int i = 0; i < Model.References.Length; i++)
                            {
                                var reference = Model.References[i];
                                var isSelected = i == selectedImageIndex;
                                var borderStyle = isSelected ? "2px solid var(--mud-palette-primary)" : "2px solid transparent";
                                <div style="@($"flex-shrink: 0; cursor: pointer; border: {borderStyle}; border-radius: 4px; padding: 2px;")"
                                     @onclick="async () => await SelectImage(reference)">
                                    <img src="@reference.Url" alt="Reference" style="max-height: 100px; max-width: 150px; object-fit: contain; display: block;" />
                                </div>
                            }
                        </div>
                    </MudPaper>

                    <!-- Main Content: Two Columns -->
                    <MudGrid Spacing="3" Style="flex: 1; min-height: 0;">
                        <!-- Left Column: Image Viewer -->
                        <MudItem xs="12" md="8">
                            <MudPaper Elevation="1" Class="image-viewer-container" Style="height: 100%; position: relative; overflow: hidden;">
                                <div style="width: 100%; height: 100%; position: relative; overflow: hidden; cursor: crosshair; touch-action: none;" 
                                     id="image-container">
                                    <img id="zoomable-image"
                                         @ref="zoomableImageRef"
                                         src="@CurrentImageUrl" 
                                         crossorigin="anonymous"
                                         alt="Reference Image"
                                         style="display: block; max-width: none; user-select: none; transform-origin: 0 0;"
                                         @oncontextmenu:preventDefault="true" />
                                    <div id="pixel-magnifier"
                                         @ref="magnifierRef" 
                                         style="position: absolute; border: 2px solid #000; background: white; display: none; z-index: 1000; pointer-events: none; width: 150px; height: 150px; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>
                                </div>
                            </MudPaper>
                        </MudItem>

                        <!-- Right Column: Color Display -->
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="1" Class="pa-4" Style="height: 100%;">
                                <MudStack Spacing="3">
                                    <MudText Typo="Typo.h6">Selected Color</MudText>
                                    @if (selectedColor != null)
                                    {
                                        <MudPaper Elevation="2" Class="pa-4" Style="@($"background-color: {selectedColor.Hex};")">
                                            <MudStack Spacing="2">
                                                <MudText Typo="Typo.body1" Style="@($"color: {GetContrastColor(selectedColor.Hex)};")">
                                                    HEX: @selectedColor.Hex
                                                </MudText>
                                                <MudText Typo="Typo.body2" Style="@($"color: {GetContrastColor(selectedColor.Hex)};")">
                                                    RGB: @selectedColor.R, @selectedColor.G, @selectedColor.B
                                                </MudText>
                                            </MudStack>
                                        </MudPaper>
                                        <MudDivider />
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            Click on the image to select a color
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudAlert Severity="Severity.Info">Click on the image to select a color</MudAlert>
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                }
            </MudStack>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Medium">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;
    [Inject] public IJSRuntime JSRuntime { get; set; } = default!;

    [Parameter] public ProjectDetails Model { get; set; } = default!;

    private ElementReference zoomableImageRef;
    private ElementReference magnifierRef;
    private IJSObjectReference? jsModule;

    private int selectedImageIndex = 0;
    private string? CurrentImageUrl => Model?.References?.Length > 0 && selectedImageIndex >= 0 && selectedImageIndex < Model.References.Length
        ? Model.References[selectedImageIndex].Url + "?cors=true"
        : null;

    private SelectedColor? selectedColor;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/PaintingProjectsManagement.Features.Projects.UI/js/imageViewer.js");
                await jsModule.InvokeVoidAsync("initializeImageViewer", "image-container", "zoomable-image", "pixel-magnifier", DotNetObjectReference.Create(this));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load image viewer JS module: {ex.Message}");
            }
        }
    }

    private async Task SelectImage(UrlReference reference)
    {
        var index = Array.IndexOf(Model.References, reference);
        if (index >= 0)
        {
            selectedImageIndex = index;
            selectedColor = null;
            StateHasChanged();
            
            // Wait for the image to load, then reset transform
            await Task.Delay(100); 
            if (jsModule != null)
            {
                await jsModule.InvokeVoidAsync("resetImageViewer");
            }
        }
    }

    [JSInvokable]
    public void SetSelectedColor(int r, int g, int b)
    {
        selectedColor = new SelectedColor { R = r, G = g, B = b };
        StateHasChanged();
    }

    private void OnContextMenu(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        // Context menu is prevented via @oncontextmenu:preventDefault="true"
    }

    private string GetContrastColor(string hexColor)
    {
        try
        {
            var r = Convert.ToInt32(hexColor.Substring(1, 2), 16);
            var g = Convert.ToInt32(hexColor.Substring(3, 2), 16);
            var b = Convert.ToInt32(hexColor.Substring(5, 2), 16);
            var brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128 ? "#000000" : "#FFFFFF";
        }
        catch
        {
            return "#000000";
        }
    }

    private void Close() => MudDialog.Close(DialogResult.Ok(true));

    public class SelectedColor
    {
        public int R { get; set; }
        public int G { get; set; }
        public int B { get; set; }
        public string Hex => $"#{R:X2}{G:X2}{B:X2}";
    }

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            await jsModule.DisposeAsync();
        }
    }
}

<style>
    .color-zones-dialog .image-viewer-container {
        background: #f5f5f5;
    }

    .color-zones-dialog .image-carousel {
        height: 120px;
    }

    #zoomable-image {
        transform-origin: 0 0;
    }
</style>

