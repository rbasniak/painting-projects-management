@page "/projects/{ProjectId}/execution"
@using MudBlazor
@using PaintingProjectsManagement.UI.Modules.Projects
@using PaintingProjectsManagement.UI.Modules.Projects.UI.Dialogs
@using PaintingProjectsManagement.UI.Modules.Shared
@using PaintingProjectsManagement.Features.Projects
@implements IAsyncDisposable

<MudPaper Class="pa-4">
    <MudStack Spacing="4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h4">@(projectDetails?.Name ?? "Project Execution")</MudText>
            <MudButton Variant="Variant.Text" 
                      Color="Color.Default" 
                      StartIcon="@Icons.Material.Filled.ArrowBack"
                      OnClick="NavigateBack">
                Back to Projects
            </MudButton>
        </MudStack>

        @if (isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else
        {
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                <!-- Reference Pictures Tab -->
                <MudTabPanel Text="Reference Pictures" Icon="@Icons.Material.Filled.Image">
                    @if (projectDetails?.References == null || !projectDetails.References.Any())
                    {
                        <MudAlert Severity="Severity.Info">No reference pictures available for this project.</MudAlert>
                    }
                    else
                    {
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6">Reference Pictures</MudText>
                            
                            <!-- Image Carousel -->
                            <MudPaper Elevation="1" Class="pa-2">
                                <MudStack Spacing="2">
                                    @if (selectedImageIndex >= 0 && selectedImageIndex < projectDetails.References.Length)
                                    {
                                        <div style="position: relative; width: 100%; height: 600px; overflow: hidden; background: #f5f5f5; border-radius: 8px;" 
                                             id="image-container">
                                            <img id="zoomable-image"
                                                 @ref="zoomableImageRef"
                                                 src="@GetPictureAddressWithCors(projectDetails.References[selectedImageIndex].Url)"
                                                 crossorigin="anonymous"
                                                 alt="Reference Image"
                                                 style="display: block; max-width: none; user-select: none; transform-origin: 0 0; width: 100%; height: 100%; object-fit: contain;"
                                                 @oncontextmenu:preventDefault="true"
                                                 @onload="OnImageLoaded"
                                                 @onerror="OnImageError" />
                                            <div id="pixel-magnifier"
                                                 @ref="magnifierRef" 
                                                 style="position: absolute; border: 2px solid #000; background: white; display: none; z-index: 1000; pointer-events: none; width: 150px; height: 150px; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>
                                        </div>
                                        
                                        <!-- Navigation Controls -->
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="2">
                                            <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                                                         OnClick="PreviousImage" 
                                                         Disabled="@(selectedImageIndex == 0)"
                                                         Color="Color.Primary" />
                                            <MudText Typo="Typo.body2">
                                                @(selectedImageIndex + 1) / @projectDetails.References.Length
                                            </MudText>
                                            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                                                         OnClick="NextImage" 
                                                         Disabled="@(selectedImageIndex >= projectDetails.References.Length - 1)"
                                                         Color="Color.Primary" />
                                        </MudStack>
                                    }
                                    
                                    <!-- Thumbnail Strip -->
                                    <div style="display: flex; gap: 8px; overflow-x: auto; padding: 8px 0;">
                                        @for (int i = 0; i < projectDetails.References.Length; i++)
                                        {
                                            var reference = projectDetails.References[i];
                                            var isSelected = i == selectedImageIndex;
                                            var borderStyle = isSelected ? "2px solid var(--mud-palette-primary)" : "2px solid transparent";
                                            <div style="@($"flex-shrink: 0; cursor: pointer; border: {borderStyle}; border-radius: 4px; padding: 2px;")"
                                                 @onclick="async () => await SelectImage(i)">
                                                <img src="@GetPictureAddressWithCors(reference.Url)" 
                                                     alt="Reference" 
                                                     style="max-height: 100px; max-width: 150px; object-fit: contain; display: block;" />
                                            </div>
                                        }
                                    </div>
                                </MudStack>
                            </MudPaper>
                        </MudStack>
                    }
                </MudTabPanel>

                <!-- Colors Tab -->
                <MudTabPanel Text="Colors" Icon="@Icons.Material.Filled.Palette">
                    @if (projectDetails?.Groups == null || !projectDetails.Groups.Any())
                    {
                        <MudAlert Severity="Severity.Info">No color groups available for this project.</MudAlert>
                    }
                    else
                    {
                        <MudStack Spacing="4">
                            <MudText Typo="Typo.h6">Color Groups Summary</MudText>
                            
                            @foreach (var group in projectDetails.Groups)
                            {
                                <MudPaper Elevation="2" Class="pa-4">
                                    <MudStack Spacing="3">
                                        <MudText Typo="Typo.h6" Style="color: var(--mud-palette-primary);">
                                            <MudIcon Icon="@Icons.Material.Filled.Palette" Class="mr-2" />
                                            @group.Name
                                        </MudText>
                                        
                                        <MudGrid Spacing="3">
                                            @foreach (var groupSection in group.Sections)
                                            {
                                                var pickedColor = groupSection.PickedColorId.HasValue 
                                                    ? groupSection.SuggestedColors?.FirstOrDefault(c => c.PaintColorId == groupSection.PickedColorId.Value)
                                                    : null;
                                                
                                                <MudItem xs="12" md="6" lg="4">
                                                    <MudPaper Elevation="1" Class="pa-3">
                                                        <MudStack Spacing="2">
                                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                                @GetZoneLabel(groupSection.Zone)
                                                            </MudText>
                                                            
                                                            <!-- Reference Color -->
                                                            <MudStack Spacing="1">
                                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Reference Color</MudText>
                                                                <div style="@($"width: 100%; height: 80px; background-color: {groupSection.ReferenceColor}; border-radius: 8px; border: 2px solid #e0e0e0;")" 
                                                                     title="Reference Color"></div>
                                                                <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                                                    @groupSection.ReferenceColor.ToUpper()
                                                                </MudText>
                                                            </MudStack>
                                                            
                                                            <!-- Picked Color -->
                                                            @if (pickedColor != null)
                                                            {
                                                                <MudStack Spacing="1">
                                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Picked Color</MudText>
                                                                    <div style="@($"width: 100%; height: 80px; background-color: {pickedColor.HexColor}; border-radius: 8px; border: 2px solid var(--mud-palette-primary);")" 
                                                                         title="Picked Color"></div>
                                                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                                                        @pickedColor.Name
                                                                    </MudText>
                                                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                                                        @pickedColor.BrandName Â· @pickedColor.LineName
                                                                    </MudText>
                                                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                                                        @pickedColor.HexColor.ToUpper()
                                                                    </MudText>
                                                                </MudStack>
                                                            }
                                                            else
                                                            {
                                                                <MudStack Spacing="1">
                                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Picked Color</MudText>
                                                                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: #f5f5f5; border: 2px dashed #ccc;">
                                                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                                                            No color picked yet
                                                                        </MudText>
                                                                    </MudPaper>
                                                                </MudStack>
                                                            }
                                                        </MudStack>
                                                    </MudPaper>
                                                </MudItem>
                                            }
                                        </MudGrid>
                                    </MudStack>
                                </MudPaper>
                            }
                        </MudStack>
                    }
                </MudTabPanel>

                <!-- Materials Tab -->
                <MudTabPanel Text="Materials" Icon="@Icons.Material.Filled.Build">
                    <MudStack Spacing="3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h6">Project Materials</MudText>
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      Size="Size.Large"
                                      StartIcon="@Icons.Material.Filled.Add"
                                      OnClick="AddMaterial">
                                Add Material
                            </MudButton>
                        </MudStack>

                        @if (isLoadingMaterials)
                        {
                            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
                        }
                        else if (materials.Any())
                        {
                            <MudTable Items="materials" Hover="true" Dense="false" Striped="true">
                                <HeaderContent>
                                    <MudTh>Category</MudTh>
                                    <MudTh>Material</MudTh>
                                    <MudTh>Quantity</MudTh>
                                    <MudTh Style="width: 150px;">Actions</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd>@context.CategoryName</MudTd>
                                    <MudTd>@context.MaterialName</MudTd>
                                    <MudTd>@context.QuantityFormatted</MudTd>
                                    <MudTd>
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                      OnClick="() => EditQuantity(context)" 
                                                      Color="Color.Primary" 
                                                      Size="Size.Small" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                      OnClick="() => DeleteMaterial(context)" 
                                                      Color="Color.Error" 
                                                      Size="Size.Small" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">No materials added to this project yet.</MudAlert>
                        }
                    </MudStack>
                </MudTabPanel>

                <!-- Execution Tab -->
                <MudTabPanel Text="Execution" Icon="@Icons.Material.Filled.List">
                    <MudStack Spacing="3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h6">Project Execution Steps</MudText>
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      Size="Size.Large"
                                      StartIcon="@Icons.Material.Filled.Add"
                                      OnClick="AddStep">
                                Add Step
                            </MudButton>
                        </MudStack>

                        @if (isLoadingSteps)
                        {
                            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
                        }
                        else if (stepsGrouped.StepsByType.Any())
                        {
                            <MudExpansionPanels MultiExpansion="true">
                                @foreach (var group in stepsGrouped.StepsByType.OrderBy(x => x.Key))
                                {
                                    <MudExpansionPanel Icon="@Icons.Material.Filled.KeyboardArrowDown">
                                        <TitleContent>
                                            <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
                                                <MudText>@group.Value.First().Step.Value</MudText>
                                                <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">@FormatDuration(group.Value.Sum(x => x.DurationInHours))</MudChip>
                                            </div>
                                        </TitleContent>
                                        <ChildContent>
                                            <MudTable Items="group.Value" Hover="true" Dense="false" Striped="true">
                                                <HeaderContent>
                                                    <MudTh>Date</MudTh>
                                                    <MudTh>Duration</MudTh>
                                                    <MudTh Style="width: 150px;">Actions</MudTh>
                                                </HeaderContent>
                                                <RowTemplate>
                                                    <MudTd>@FormatDate(context.Date)</MudTd>
                                                    <MudTd>@FormatDuration(context.DurationInHours)</MudTd>
                                                    <MudTd>
                                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                                      OnClick="() => EditStep(context)" 
                                                                      Color="Color.Primary" 
                                                                      Size="Size.Small" />
                                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                                      OnClick="() => DeleteStep(context)" 
                                                                      Color="Color.Error" 
                                                                      Size="Size.Small" />
                                                    </MudTd>
                                                </RowTemplate>
                                            </MudTable>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                }
                            </MudExpansionPanels>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">No execution steps recorded yet.</MudAlert>
                        }
                    </MudStack>
                </MudTabPanel>
            </MudTabs>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter] public string ProjectId { get; set; } = string.Empty;

    [Inject] public IProjectsService ProjectsService { get; set; } = default!;
    [Inject] public IDialogService DialogService { get; set; } = default!;
    [Inject] public ISnackbar Snackbar { get; set; } = default!;
    [Inject] public NavigationManager NavigationManager { get; set; } = default!;
    [Inject] public IJSRuntime JSRuntime { get; set; } = default!;

    private ProjectDetails? projectDetails;
    private bool isLoading = true;
    
    // Reference Pictures
    private ElementReference zoomableImageRef;
    private ElementReference magnifierRef;
    private IJSObjectReference? jsModule;
    private int selectedImageIndex = 0;

    // Materials
    private List<ProjectMaterialDetails> materials = new();
    private bool isLoadingMaterials = false;

    // Execution Steps
    private ProjectStepsGrouped stepsGrouped = new();
    private bool isLoadingSteps = false;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(ProjectId))
        {
            throw new ArgumentNullException(nameof(ProjectId));
        }

        await LoadProjectDetailsAsync();
        await LoadMaterialsAsync();
        await LoadStepsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && projectDetails?.References != null && projectDetails.References.Any() && selectedImageIndex >= 0)
        {
            try
            {
                await Task.Delay(100); // Wait for image to render
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/PaintingProjectsManagement.Features.Projects.UI/js/imageViewer.js");
                await jsModule.InvokeVoidAsync("initializeImageViewer", "image-container", "zoomable-image", "pixel-magnifier", DotNetObjectReference.Create(this));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load image viewer JS module: {ex.Message}");
            }
        }
    }

    private async Task LoadProjectDetailsAsync()
    {
        try
        {
            isLoading = true;
            projectDetails = await ProjectsService.GetDetailsAsync(new Guid(ProjectId), default);
            if (projectDetails?.References != null && projectDetails.References.Any())
            {
                selectedImageIndex = 0;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading project details: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadMaterialsAsync()
    {
        try
        {
            isLoadingMaterials = true;
            materials = (await ProjectsService.GetProjectMaterialsAsync(new Guid(ProjectId), default)).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading materials: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingMaterials = false;
        }
    }

    private async Task LoadStepsAsync()
    {
        try
        {
            isLoadingSteps = true;
            stepsGrouped = await ProjectsService.GetProjectStepsAsync(new Guid(ProjectId), default);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading steps: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingSteps = false;
        }
    }

    // Reference Pictures Methods
    private string GetPictureAddress(string url)
    {
        if (string.IsNullOrWhiteSpace(url))
            return string.Empty;

        // Normalize path separators (convert backslashes to forward slashes)
        var normalizedUrl = url.Replace('\\', '/');
        var trimmedUrl = normalizedUrl.Trim('/');
        
        // If URL already contains query string, use it as-is, otherwise construct the full URL
        if (trimmedUrl.StartsWith("http://") || trimmedUrl.StartsWith("https://"))
        {
            return trimmedUrl;
        }
        return $"https://localhost:7236/{trimmedUrl}";
    }

    private string GetPictureAddressWithCors(string url)
    {
        var baseUrl = GetPictureAddress(url);
        // Add CORS parameter if not already present
        if (!baseUrl.Contains("?"))
        {
            return $"{baseUrl}?cors=true";
        }
        return baseUrl;
    }

    private async Task SelectImage(int index)
    {
        if (projectDetails?.References != null && index >= 0 && index < projectDetails.References.Length)
        {
            selectedImageIndex = index;
            StateHasChanged();
            
            // Wait for the new image element to be rendered
            await Task.Delay(300);
            
            // Reinitialize the JS module with the new image element
            if (jsModule != null)
            {
                try
                {
                    await jsModule.InvokeVoidAsync("initializeImageViewer", "image-container", "zoomable-image", "pixel-magnifier", DotNetObjectReference.Create(this));
                    await jsModule.InvokeVoidAsync("resetImageViewer");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error reinitializing image viewer: {ex.Message}");
                }
            }
        }
    }

    private async Task OnImageLoaded()
    {
        // Reinitialize the image viewer when a new image loads
        if (jsModule != null)
        {
            try
            {
                await Task.Delay(100);
                await jsModule.InvokeVoidAsync("initializeImageViewer", "image-container", "zoomable-image", "pixel-magnifier", DotNetObjectReference.Create(this));
                await jsModule.InvokeVoidAsync("resetImageViewer");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error reinitializing image viewer: {ex.Message}");
            }
        }
    }

    private void OnImageError()
    {
        Snackbar.Add("Failed to load image", Severity.Warning);
        Console.WriteLine($"Failed to load image: {GetPictureAddressWithCors(projectDetails?.References?[selectedImageIndex]?.Url ?? "")}");
    }

    private async Task PreviousImage()
    {
        if (selectedImageIndex > 0)
        {
            await SelectImage(selectedImageIndex - 1);
        }
    }

    private async Task NextImage()
    {
        if (projectDetails?.References != null && selectedImageIndex < projectDetails.References.Length - 1)
        {
            await SelectImage(selectedImageIndex + 1);
        }
    }

    // Materials Methods
    private async Task AddMaterial()
    {
        var parameters = new DialogParameters 
        { 
            ["ProjectId"] = ProjectId
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<AddMaterialWizardDialog>("Add Material", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadMaterialsAsync();
        }
    }

    private async Task EditQuantity(ProjectMaterialDetails material)
    {
        var parameters = new DialogParameters 
        { 
            ["Material"] = material,
            ["ProjectId"] = ProjectId
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<AdjustMaterialQuantityDialog>("Adjust Quantity", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadMaterialsAsync();
        }
    }

    private async Task DeleteMaterial(ProjectMaterialDetails material)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Delete Material",
            $"Remove '{material.MaterialName}' from this project?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await ProjectsService.DeleteProjectMaterialAsync(new Guid(ProjectId), material.MaterialId, default);
                Snackbar.Add("Material removed successfully", Severity.Success);
                await LoadMaterialsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting material: {ex.Message}", Severity.Error);
            }
        }
    }

    // Execution Steps Methods
    private async Task AddStep()
    {
        var parameters = new DialogParameters 
        { 
            ["ProjectId"] = ProjectId
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<AddStepDialog>("Add Execution Step", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadStepsAsync();
        }
    }

    private async Task EditStep(ProjectStepDetails step)
    {
        var parameters = new DialogParameters 
        { 
            ["Step"] = step,
            ["ProjectId"] = ProjectId
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<AdjustStepDurationDialog>("Edit Step", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            await LoadStepsAsync();
        }
    }

    private async Task DeleteStep(ProjectStepDetails step)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Delete Step",
            $"Delete this execution step?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await ProjectsService.DeleteProjectStepAsync(new Guid(ProjectId), step.Id, default);
                Snackbar.Add("Step deleted successfully", Severity.Success);
                await LoadStepsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting step: {ex.Message}", Severity.Error);
            }
        }
    }

    private static string FormatDuration(double hours)
    {
        var wholeHours = (int)Math.Floor(hours);
        var minutes = (int)Math.Round((hours - wholeHours) * 60);
        if (minutes == 60)
        {
            wholeHours += 1;
            minutes = 0;
        }
        return $"{wholeHours}h {(minutes > 0 ? $"{minutes}min" : "0min")}";
    }

    private static string FormatDate(DateTime date)
    {
        return $"{date:dd MMM yyyy HH}h{date:mm}min";
    }

    private string GetZoneLabel(ColorZone zone)
    {
        return zone switch
        {
            ColorZone.Highlight => "Highlights",
            ColorZone.Midtone => "Midtones",
            ColorZone.Shadow => "Shadows",
            _ => zone.ToString()
        };
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/projects/my-projects");
    }

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            await jsModule.DisposeAsync();
        }
    }
}

<style>
    #zoomable-image {
        transform-origin: 0 0;
    }
</style>
